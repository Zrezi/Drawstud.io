<!DOCTYPE html>
<html>
	<head>
		<title>Drawstud.io - Dashboard</title>
		<meta charset="utf-8">

		<!-- JQUERY -->
		<script src="../js/plugins/JQuery-Min.js"></script>

		<!-- MATERIALIZE CSS -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">

		<!-- MATERIALIZE JAVASCRIPT -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>

		<!-- LOAD MATERIAL ICONS -->
		<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

		<!-- SOCKET IO -->
		<script src="../socket.io/socket.io.js"></script>

		<!-- CSS -->
		<style>
			.login-page {
				width: 70vw;
				margin: auto;
			}
			.login-form {
				position: relative;
				z-index: 1;
				background: #FFFFFF;
				margin: 0 auto 50px;
				padding: 10vh;
				text-align: center;
				outline: 8px white dashed;
			}
			.login-form > p {
				text-align: center;
				color: #bdbdbd;
			}
			.login-form > h1 {
				text-align: center;
				color: #4db6ac;
			}
			.btn {
				margin-top: 10px;
				margin-bottom: 10px;
			}
			#fade-wrapper {
				display: none;
			}
			.modal-content > h4 {
				text-align: center;
				color: #4db6ac;
				margin-bottom: 40px;
			}
			.collapsible-header {
				color: #4db6ac;
			}
			.footer {
				text-align: center;
				position: fixed;
				color: #009688;
				bottom: 0;
				width: 100%;
			}
			#toast-container {
				top: 10%;
				right: 10%;
				bottom: auto !important;
				left: auto !important;
			}
		</style>

		<script>

			var MATERIALIZE_TOAST_MS = 2500;

			var socket;

			var rooms = {};

			$(document).ready(function() {

				// Change the header to the username text
				$('#username').text(sessionStorage.getItem('dsio__username'));

				// Connect to the socket and quit if it doesn't connect
				socket  = io.connect();
				if (!socket) {
					console.log('IO DIDN\'T WORK');
					return false;
				}

				// Materialize javascript call to initialize modals
				$('.modal').modal();

				// View Profile Button Listener
				// Opens the Profile modal
				$('#viewProfile')[0].addEventListener('click', function(e) {
					e.preventDefault();
					$('#modal-profile').modal('open');
				});

				// Create a Room Button Listener
				// Opens the CaR modal
				$('#createRoom')[0].addEventListener('click', function(e) {
					e.preventDefault();
					$('#modal-createRoom').modal('open');
				});

				// View Rooms Button Listener
				// Opens the View Rooms modal and requests the server for a list of rooms
				$('#viewRooms')[0].addEventListener('click', function(e) {
					e.preventDefault();
					socket.emit('SERVER REQUEST VIEW ROOMS');
					$('#modal-viewRooms').modal('open');
				});

				// Logout Button Listener
				// Clears all session storage variables generated by Drawstud.io and returns
				// the user to the login screen
				$('#logout')[0].addEventListener('click', function(e) {
					sessionStorage.removeItem('dsio__username');
					sessionStorage.removeItem('dsio__room');
					document.location.href = "Login.html";
				});

				// Create room button listener (within the CaR modal)
				// Makes sure that the input is entirely alphabetical, then sends a request to the server
				// to make sure that the room doesn't already exist
				$('#createRoomButton')[0].addEventListener('click', function(e) {
					var text = $('#roomNameInput').val();
					if (!/[^a-z]/i.test(text) && text != '' && text != null) {
						socket.emit('SERVER REQUEST CREATE ROOM', text);
						$('#modal-createRoom').modal('close');
					} else {
						Materialize.toast('Only letters! No spaces or other characters, sorry!', MATERIALIZE_TOAST_MS);
					}
				});

				socket.on('CLIENT INITIAL CONNECT' ,function() {
					socket.emit('SERVER INITIAL CONNECT', "dashboard");
				});

				socket.on('CLIENT UPDATE VIEW ROOMS DATA', function(data) {

					// Reset information table, recreate it dynamically from the server, and append it to the view room modal
					$('#roomInformation').html('');
					var element = '<table id="#generatedTable">';
					element += '<thead><tr><th data-field="name">Name</th><th data-field="connect">Connect</th></tr></thead>';
					element += '<tbody>'
					for (var i in data) {
						element += '<tr><td>' + data[i] + '</td><td><button class="btn" id="room-' + data[i] + '">Connect</button></td></tr>'
					}
					element += '</tbody></table>'

					// Add click listeners on all of them
					// Had to do it this way with the buttonLocations object in order to avoid overwriting of button session
					// storage variable setting. This way seemed to fix that error
					var buttonLocations = {};
					for (var i = 0; i < data.length; i++) {
						var name = '#room-' + data[i];
						buttonLocations[name] = data[i];
						generateClickEvent(name);
					}
					function generateClickEvent(element) {
						$(document).on('click', element, function(e) {
							sessionStorage.setItem('dsio__room', buttonLocations[element]);
							document.location.href = "DrawingRoom.html";
						});
					}

					// Add the generated HTML to the modal
					$('#roomInformation').append(element);
				});

				// On room creation success
				socket.on('CLIENT UPDATE CREATE ROOM SUCCESS', function(data) {

					// Set the session storage room
					sessionStorage.setItem('dsio__room', data);
					console.log('Set dsio__room to ' + data);

					// Change the page to the drawing room
					// DrawingRoom.html will take a look at the sessionStorage item stored above and go from there
					document.location.href = "DrawingRoom.html";
				});

				// Alert the user that the room they tried to create already exists
				socket.on('CLIENT UPDATE CREATE ROOM FAILED', function(data) {
					Materialize.toast('That room already exists!', MATERIALIZE_TOAST_MS);
				});

			    socket.on('CLIENT UPDATE CONNECTED USERS AMOUNT', function(data) {
			       $('#onlinePeople').html(data); 
			    });

				// After generating everything, fade in the page
				$('#fade-wrapper').fadeIn(500);

			});

		</script>

	</head>
	<body class="teal accent-2">

		<!-- FADE WRAPPING -->
		<div id="fade-wrapper">

			<!-- SPACER FOR THE TOP OF THE SCREEN -->
			<div style="height: 10vh;"></div>

			<!-- PAGE CONTENT -->
			<div class="login-page">
				<div class="form z-depth-3">
					<div class="login-form">
						<h1 id="username"></h1>
						<div style="height: 2.5vh;"></div>
						<div class="row">
							<div class="col l4 m12">
								<button class="btn col s12" id="viewRooms">View Rooms</button>
							</div>
							<div class="col l4 m12">
								<button class="btn col s12" id="createRoom">Create a Room</button>
							</div>
							<div class="col l4 m12">
								<button class="btn col s12" id="viewProfile">View Profile</button>
							</div>
						</div>
						<div style="height: 2.5vh;"></div>
						<button class="btn col s12" id="logout">Logout</button>
					</div>
				</div>
			</div>

			<!-- STANDARD FOOTER -->
			<div class="footer">
				<p>Created by Zach Reznicek &copy; 2016 Currently <span id="onlinePeople">some</span> people online now. View the <a href="https://github.com/Zrezi/Drawstud.io">Github page here.</a></p>
			</div>

		</div>

		<!-- VIEW ROOMS MODAL -->
		<div id="modal-viewRooms" class="modal">
			<div class="modal-content">
				<h4>View Rooms</h4>
				<div id="roomInformation">
					<!-- WILL BE REPLACED DYNAMICALLY WITH THE VIEWROOM BUTTON CALL -->
				</div>
			</div>
			<div class="modal-footer">
				<a class="modal-action modal-close btn-flat">Return</a>
			</div>
		</div>

		<!-- CREATE A ROOM MODAL -->
		<div id="modal-createRoom" class="modal">
			<div class="modal-content">
				<h4>Create a Room</h4>
				<div class="input-field">
					<input placeholder="Room Name" id="roomNameInput" type="text" class="validate" autocomplete="off">
					<label for="roomNameInput">Room Name</label>
				</div>
			</div>
			<div class="modal-footer">
				<a class="modal-action modal-close btn-flat">Return</a>
				<a class="modal-action btn-flat" id="createRoomButton">Create Room</a>
			</div>
		</div>

		<!-- PROFILE MODAL -->
		<div id="modal-profile" class="modal">
			<div class="modal-content">
				<h4>Profile</h4>
				<ul class="collapsible" data-collapsible="accordion">
					<li>
						<div class="collapsible-header"><i class="material-icons">person</i>Social</div>
						<div class="collapsible-body"><p>Coming soon...</p></div>
					</li>
					<li>
						<div class="collapsible-header"><i class="material-icons">poll</i>Statistics</div>
						<div class="collapsible-body"><p>Coming soon...</p></div>
					</li>
					<li>
						<div class="collapsible-header"><i class="material-icons">settings</i>Settings</div>
						<div class="collapsible-body"><p>Coming soon...</p></div>
					</li>
				</ul>
			</div>
			<div class="modal-footer">
				<a class="modal-action modal-close btn-flat">Return</a>
			</div>
		</div>

	</body>
</html>